<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Building a Video Upload Demo with Node.js and api.video</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Building a Video Upload Demo with Node.js and api.video</h1>
</header>
<section data-field="subtitle" class="p-summary">
Here at api.video, we love making video delivery easy for our customers. We take care of doing all the video transcoding and video…
</section>
<section data-field="body" class="e-content">
<section name="8b65" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="1198" id="1198" class="graf graf--h3 graf--leading graf--title">Building a Video Upload Demo with Node.js and api.video</h3><p name="85d5" id="85d5" class="graf graf--p graf-after--h3">Here at <a href="http://api.video" data-href="http://api.video" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">api.video</a>, we love making video delivery easy for our customers. We take care of doing all the video transcoding and video streaming so that you can worry about all the other facets of your product. Using our APIs (and our SDKs) are a straightforward and easy way to add video to your service. In this post, we’ll walk through the steps to create a website where you can upload videos. In fact, you can try out this code with the api.video at: <a href="http://api.video/upload-demo" data-href="http://api.video/upload-demo" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">api.video/upload-demo</a></p><p name="6957" id="6957" class="graf graf--p graf-after--p">In this post, we’ll walk through the code, so that you can build it yourself, but if you’re in a rush, the completed code is also hosted on <a href="https://github.com/dougsillars/videosite" data-href="https://github.com/dougsillars/videosite" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">GitHub</a>.</p><h3 name="93ec" id="93ec" class="graf graf--h3 graf-after--p">Overall Architecture</h3><figure name="4351" id="4351" class="graf graf--figure graf-after--h3"><div class="aspectRatioPlaceholder is-locked" style="max-width: 565px; max-height: 377px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 66.7%;"></div><img class="graf-image" data-image-id="1*Vje7Cz76uC0VTHLkrAmGFQ.png" data-width="565" data-height="377" alt="Overall architecture api.video" src="https://cdn-images-1.medium.com/max/800/1*Vje7Cz76uC0VTHLkrAmGFQ.png"></div></figure><ol class="postList"><li name="a7dd" id="a7dd" class="graf graf--li graf-after--figure">Starting with a web form, a video is submitted to the Node server.</li><li name="8968" id="8968" class="graf graf--li graf-after--li">The video is immediately uploaded to api.video for processing</li><li name="6ef6" id="6ef6" class="graf graf--li graf-after--li">api.video acknowledges the video upload, returns the videoId, and begins encoding the video.</li><li name="3941" id="3941" class="graf graf--li graf-after--li">The node server polls api.video to obtain the playable status (confirming that encoding is completed).</li><li name="67fa" id="67fa" class="graf graf--li graf-after--li">As long as the result is “false”, the polling continues.</li><li name="e060" id="e060" class="graf graf--li graf-after--li">When the video is playable, the node server returns a page with the video. The video autoplays to show that the video is ready to play. The page also returns the timings for upload &amp; for video processing.</li><li name="4574" id="4574" class="graf graf--li graf-after--li">(optional) The video link is e-mailed to the user.</li></ol><h3 name="7c8d" id="7c8d" class="graf graf--h3 graf-after--li">Getting Started</h3><h3 name="41f2" id="41f2" class="graf graf--h3 graf-after--h3">Node &amp; Dependencies</h3><p name="b961" id="b961" class="graf graf--p graf-after--h3">It is beyond the scope of this post to get you started, but if you are new to Node.js, take a look at this series of posts by<a href="https://www.robinwieruch.de/minimal-node-js-babel-setup" data-href="https://www.robinwieruch.de/minimal-node-js-babel-setup" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"> Robin Weiruch</a> — they’ll help you build a Node environment with Express, Babel, environmental variables and Nodemon.</p><p name="2bb4" id="2bb4" class="graf graf--p graf-after--p">There are a number of required node dependencies:</p><blockquote name="c4d7" id="c4d7" class="graf graf--blockquote graf-after--p">npm install express dotenv @api.video/nodejs-sdk fs pug serve-favicon formidable email-validator</blockquote><p name="3a1f" id="3a1f" class="graf graf--p graf-after--blockquote">This tutorial also optionally connects to Intercom to send emails to your users. This will require:</p><blockquote name="8098" id="8098" class="graf graf--blockquote graf-after--p">npm install intercom-client</blockquote><h3 name="665a" id="665a" class="graf graf--h3 graf-after--blockquote">Building the Site</h3><h3 name="d81a" id="d81a" class="graf graf--h3 graf-after--h3">Starting index.js</h3><p name="a5ed" id="a5ed" class="graf graf--p graf-after--h3">You can clone the GitHub repository to follow along, but here is the code that builds your video uploader:</p><p name="8e47" id="8e47" class="graf graf--p graf-after--p">In the src/index.js file, copy the following code:</p><blockquote name="cf85" id="cf85" class="graf graf--blockquote graf-after--p">import ‘dotenv/config’;</blockquote><blockquote name="fb45" id="fb45" class="graf graf--blockquote graf-after--blockquote">import express from ‘express’;</blockquote><blockquote name="c3fa" id="c3fa" class="graf graf--blockquote graf-after--blockquote">const app = express();</blockquote><blockquote name="60e6" id="60e6" class="graf graf--blockquote graf-after--blockquote">const pug = require(‘pug’);</blockquote><blockquote name="2a95" id="2a95" class="graf graf--blockquote graf-after--blockquote">app.use(express.json());</blockquote><blockquote name="e304" id="e304" class="graf graf--blockquote graf-after--blockquote">app.use(express.urlencoded({ extended: true }));</blockquote><blockquote name="18f2" id="18f2" class="graf graf--blockquote graf-after--blockquote">app.set(‘view engine’,’pug’);</blockquote><blockquote name="d028" id="d028" class="graf graf--blockquote graf-after--blockquote">app.use(express.static(‘public/’));</blockquote><blockquote name="d3ca" id="d3ca" class="graf graf--blockquote graf-after--blockquote">//favicons are the cool little icon in the browser tab</blockquote><blockquote name="1231" id="1231" class="graf graf--blockquote graf-after--blockquote">var favicon = require(‘serve-favicon’);</blockquote><blockquote name="0a36" id="0a36" class="graf graf--blockquote graf-after--blockquote">app.use(favicon(‘public/icon.ico’));</blockquote><blockquote name="b2f9" id="b2f9" class="graf graf--blockquote graf-after--blockquote">app.get(‘/upload-demo’, (req, res) =&gt; {</blockquote><blockquote name="89ec" id="89ec" class="graf graf--blockquote graf-after--blockquote">return res.render(‘start’);</blockquote><blockquote name="e3d3" id="e3d3" class="graf graf--blockquote graf-after--blockquote">});</blockquote><blockquote name="a6ff" id="a6ff" class="graf graf--blockquote graf-after--blockquote">app.listen(3000, () =&gt;</blockquote><blockquote name="edbd" id="edbd" class="graf graf--blockquote graf-after--blockquote">console.log(‘Example app listening on port 3000!’),</blockquote><blockquote name="64b6" id="64b6" class="graf graf--blockquote graf-after--blockquote">);</blockquote><p name="37bd" id="37bd" class="graf graf--p graf-after--blockquote">In this snippet, Node imports Express (and dotenv for environmental variables). The first big chuck of code creates and sets up an express app. It will use Pug to build the views. Static files are saved in the ‘public/’ directory, and serve-favicon adds the favicon to the site. You can use the default favico in the public directory on GitHub, or create your own.</p><p name="ac17" id="ac17" class="graf graf--p graf-after--p">Next we have app.get — on the default entry point of the site. If a request occurs at the “/upload-demo” directory of the web server, we’ll deliver the start.pug file that is saved in the views directory.</p><p name="9098" id="9098" class="graf graf--p graf-after--p">Finally, the app listens on port 3000 for requests. If you run npm start from the terminal, you should get a response of “Example app listening on port 3000!” You can now enter “localhost:3000/upload-demo” into your browser, and if you have added the views directory — you’ll see the form. If you have not yet added the view, you’ll probably get an error.</p><h3 name="8001" id="8001" class="graf graf--h3 graf-after--p">Start.pug</h3><p name="1387" id="1387" class="graf graf--p graf-after--h3">The landing page is simply an introductory text describing the upload and a form to select the file. This page is created with Pug. Pug is really persnickety about indentation spaces, so it might be best to copy the code (of just use the code) from GitHub rather than copy and paste from this post.</p><p name="930a" id="930a" class="graf graf--p graf-after--p">In the head tag, we load some CSS and the favicon.</p><blockquote name="504f" id="504f" class="graf graf--blockquote graf-after--p">head</blockquote><blockquote name="a669" id="a669" class="graf graf--blockquote graf-after--blockquote">link(rel=’stylesheet’, href=’../style.css’)</blockquote><blockquote name="2283" id="2283" class="graf graf--blockquote graf-after--blockquote">link(rel=’icon’, href=’icon.ico’, type=’image/x-icon’)</blockquote><blockquote name="f862" id="f862" class="graf graf--blockquote graf-after--blockquote">body</blockquote><blockquote name="8da2" id="8da2" class="graf graf--blockquote graf-after--blockquote">header.header</blockquote><blockquote name="5239" id="5239" class="graf graf--blockquote graf-after--blockquote">h1 Test out api.video</blockquote><blockquote name="8aba" id="8aba" class="graf graf--blockquote graf-after--blockquote">h2 Upload a video, and have an encoded video stream in no time!</blockquote><blockquote name="bbdb" id="bbdb" class="graf graf--blockquote graf-after--blockquote">h2 Add your e-mail address to receive a link to our video without watermark.</blockquote><blockquote name="2fe9" id="2fe9" class="graf graf--blockquote graf-after--blockquote">h2 If you do not submit an e-mail address, your video will be watermarked and deleted after 72 hours.</blockquote><blockquote name="18d5" id="18d5" class="graf graf--blockquote graf-after--blockquote">form(action=”/” method = “POST” enctype=”multipart/form-data”).form</blockquote><blockquote name="f66f" id="f66f" class="graf graf--blockquote graf-after--blockquote">p</blockquote><blockquote name="0d06" id="0d06" class="graf graf--blockquote graf-after--blockquote">| Video Name:</blockquote><blockquote name="3d69" id="3d69" class="graf graf--blockquote graf-after--blockquote">input(type=’text’, name=’title’, value=”video title”).input</blockquote><blockquote name="2b7f" id="2b7f" class="graf graf--blockquote graf-after--blockquote">p</blockquote><blockquote name="2562" id="2562" class="graf graf--blockquote graf-after--blockquote">| Email Address:</blockquote><blockquote name="7ac7" id="7ac7" class="graf graf--blockquote graf-after--blockquote">input(type=’email’, name=’email’).input</blockquote><blockquote name="5158" id="5158" class="graf graf--blockquote graf-after--blockquote">p</blockquote><blockquote name="622f" id="622f" class="graf graf--blockquote graf-after--blockquote">|Save as Mp4?</blockquote><blockquote name="886a" id="886a" class="graf graf--blockquote graf-after--blockquote">input(type=’radio’, name=’mp4&#39;, value=’true’, checked)</blockquote><blockquote name="d47e" id="d47e" class="graf graf--blockquote graf-after--blockquote">| true</blockquote><blockquote name="5cbf" id="5cbf" class="graf graf--blockquote graf-after--blockquote">input(type=’radio’, name=’mp4&#39;, value=’false’)</blockquote><blockquote name="45f2" id="45f2" class="graf graf--blockquote graf-after--blockquote">| false</blockquote><blockquote name="2f77" id="2f77" class="graf graf--blockquote graf-after--blockquote">p</blockquote><blockquote name="52f9" id="52f9" class="graf graf--blockquote graf-after--blockquote">input(type=’file’, name=’source’).input</blockquote><blockquote name="8eb7" id="8eb7" class="graf graf--blockquote graf-after--blockquote">input(type=’hidden’ name=’metadata’ value=’{“videoUpload”:”true”}’)</blockquote><blockquote name="3030" id="3030" class="graf graf--blockquote graf-after--blockquote">p</blockquote><blockquote name="6e08" id="6e08" class="graf graf--blockquote graf-after--blockquote">p</blockquote><blockquote name="6116" id="6116" class="graf graf--blockquote graf-after--blockquote">input(type=’submit’, value=’Submit’)</blockquote><figure name="9260" id="9260" class="graf graf--figure graf-after--blockquote"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 518px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 74%;"></div><img class="graf-image" data-image-id="1*TYt3r7BUqqfd4QTXAtVrQA.png" data-width="799" data-height="591" src="https://cdn-images-1.medium.com/max/800/1*TYt3r7BUqqfd4QTXAtVrQA.png"></div></figure><p name="e8ab" id="e8ab" class="graf graf--p graf-after--figure">The body loads descriptive text on api.video, and the submission form. The form takes 4 inputs: video name, e-mail, true/false mp4 support and the video file. You may notice that the form action will reload the root directory of the server. Since the data submission is a POST, it will be easy to identify the 2nd request.</p><h3 name="4695" id="4695" class="graf graf--h3 graf-after--p">POST Form Processing</h3><p name="e031" id="e031" class="graf graf--p graf-after--h3">Add these additional lines to the index.js. At the top of the file, we need to add dependencies:</p><blockquote name="109a" id="109a" class="graf graf--blockquote graf-after--p">//apivideo</blockquote><blockquote name="406a" id="406a" class="graf graf--blockquote graf-after--blockquote">const apiVideo = require(‘@api.video/nodejs-sdk’);</blockquote><blockquote name="7537" id="7537" class="graf graf--blockquote graf-after--blockquote">//set up api.video client with my production key</blockquote><blockquote name="83b7" id="83b7" class="graf graf--blockquote graf-after--blockquote">//I keep my key in a .env file to keep it private.</blockquote><blockquote name="532a" id="532a" class="graf graf--blockquote graf-after--blockquote">//if you have a .env file, make sure you add it to your .gitignore file</blockquote><blockquote name="aaad" id="aaad" class="graf graf--blockquote graf-after--blockquote">var client = new apiVideo.Client({ apiKey: process.env.apivideoKeyProd});</blockquote><blockquote name="18b2" id="18b2" class="graf graf--blockquote graf-after--blockquote">//formidable takes the form data and saves the file, and parameterises the fields into JSON</blockquote><blockquote name="c9e0" id="c9e0" class="graf graf--blockquote graf-after--blockquote">const formidable = require(‘formidable’)</blockquote><blockquote name="7dd9" id="7dd9" class="graf graf--blockquote graf-after--blockquote">//email-validator to validate the email address</blockquote><blockquote name="0424" id="0424" class="graf graf--blockquote graf-after--blockquote">var validator = require(“email-validator”);</blockquote><blockquote name="c1f8" id="c1f8" class="graf graf--blockquote graf-after--blockquote">//create timers to measure upload and processing timings</blockquote><blockquote name="e018" id="e018" class="graf graf--blockquote graf-after--blockquote">let startUploadTimer;</blockquote><blockquote name="3965" id="3965" class="graf graf--blockquote graf-after--blockquote">let uploadCompleteTimer;</blockquote><blockquote name="98d9" id="98d9" class="graf graf--blockquote graf-after--blockquote">let playReadyTimer;</blockquote><p name="67f4" id="67f4" class="graf graf--p graf-after--blockquote">api.video is our backend where uploaded videos are transcoded into video streams. We add the SDK, and then I store my API key in a .env file. I have added the .env file to my .<a href="https://git-scm.com/docs/gitignore" data-href="https://git-scm.com/docs/gitignore" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">gitignore</a> file so that when I post my code on GitHub, my key is not uploaded and remains secure.</p><p name="4f3a" id="4f3a" class="graf graf--p graf-after--p">We also add formidable to read the form data and save the video locally on the Node server. The e-mail validator does what it sounds like it might do, and finally I add three variables to measure how quickly the service handles the video processing.</p><p name="6a13" id="6a13" class="graf graf--p graf-after--p">In the body of index.js, add the following:</p><blockquote name="1ebc" id="1ebc" class="graf graf--blockquote graf-after--p">app.post(‘/upload-demo’, (req,res) =&gt;{</blockquote><blockquote name="6949" id="6949" class="graf graf--blockquote graf-after--blockquote">//formidable reads the form</blockquote><blockquote name="8e03" id="8e03" class="graf graf--blockquote graf-after--blockquote">var form = new formidable.IncomingForm();</blockquote><blockquote name="09f5" id="09f5" class="graf graf--blockquote graf-after--blockquote">//use .env feil to set the directory for the video uploads</blockquote><blockquote name="2eb1" id="2eb1" class="graf graf--blockquote graf-after--blockquote">//since we will be deleting the files after they uplaod to api.video</blockquote><blockquote name="985c" id="985c" class="graf graf--blockquote graf-after--blockquote">//make sure this directory is full write and delete</blockquote><blockquote name="4dff" id="4dff" class="graf graf--blockquote graf-after--blockquote">form.uploadDir = process.env.videoDir;</blockquote><blockquote name="04c8" id="04c8" class="graf graf--blockquote graf-after--blockquote">//TODO form validation (mp4 file type, etc)</blockquote><blockquote name="5c6c" id="5c6c" class="graf graf--blockquote graf-after--blockquote">form.parse(req, (err, fields, files) =&gt; {</blockquote><blockquote name="d73c" id="d73c" class="graf graf--blockquote graf-after--blockquote">if (err) {</blockquote><blockquote name="5627" id="5627" class="graf graf--blockquote graf-after--blockquote">console.error(‘Error’, err);</blockquote><blockquote name="e329" id="e329" class="graf graf--blockquote graf-after--blockquote">throw err;</blockquote><blockquote name="81ee" id="81ee" class="graf graf--blockquote graf-after--blockquote">}</blockquote><blockquote name="2588" id="2588" class="graf graf--blockquote graf-after--blockquote">//testing — writing fields and info on the file to the log</blockquote><blockquote name="7775" id="7775" class="graf graf--blockquote graf-after--blockquote">console.log(‘Fields’, fields);</blockquote><blockquote name="c277" id="c277" class="graf graf--blockquote graf-after--blockquote">//console.log(‘Files’, files.source);</blockquote><blockquote name="aed6" id="aed6" class="graf graf--blockquote graf-after--blockquote">//console.log(‘file size’, files.source.size);</blockquote><blockquote name="0b75" id="0b75" class="graf graf--blockquote graf-after--blockquote">//console.log(‘file path’, files.source.path);</blockquote><blockquote name="fdfa" id="fdfa" class="graf graf--blockquote graf-after--blockquote">//mp4 support must be boolean — so set to false</blockquote><blockquote name="2abf" id="2abf" class="graf graf--blockquote graf-after--blockquote">//then modify to true if the form has it set to true</blockquote><blockquote name="4b90" id="4b90" class="graf graf--blockquote graf-after--blockquote">let mp4Support = false;</blockquote><blockquote name="706a" id="706a" class="graf graf--blockquote graf-after--blockquote">if (fields.mp4 ==”true”){</blockquote><blockquote name="efb7" id="efb7" class="graf graf--blockquote graf-after--blockquote">mp4Support = true;</blockquote><blockquote name="9cde" id="9cde" class="graf graf--blockquote graf-after--blockquote">}</blockquote><blockquote name="5244" id="5244" class="graf graf--blockquote graf-after--blockquote">//if email address is added use prod</blockquote><blockquote name="4e34" id="4e34" class="graf graf--blockquote graf-after--blockquote">let useProduction = true;</blockquote><blockquote name="534a" id="534a" class="graf graf--blockquote graf-after--blockquote">console.log(‘valid email?’, fields.email, validator.validate(fields.email));</blockquote><blockquote name="85e8" id="85e8" class="graf graf--blockquote graf-after--blockquote">if(validator.validate(fields.email)){</blockquote><blockquote name="f690" id="f690" class="graf graf--blockquote graf-after--blockquote">//prod</blockquote><blockquote name="4e10" id="4e10" class="graf graf--blockquote graf-after--blockquote">console.log(“using production!”);</blockquote><blockquote name="0f45" id="0f45" class="graf graf--blockquote graf-after--blockquote">}else{</blockquote><blockquote name="e03c" id="e03c" class="graf graf--blockquote graf-after--blockquote">//sandbox</blockquote><blockquote name="5d8b" id="5d8b" class="graf graf--blockquote graf-after--blockquote">//set up api.video client with my sandbox key</blockquote><blockquote name="8223" id="8223" class="graf graf--blockquote graf-after--blockquote">client = new apiVideo.ClientSandbox({ apiKey: process.env.apivideoKeySandBox});</blockquote><blockquote name="e6cc" id="e6cc" class="graf graf--blockquote graf-after--blockquote">console.log(“using sandbox!”);</blockquote><blockquote name="5a69" id="5a69" class="graf graf--blockquote graf-after--blockquote">useProduction = false;</blockquote><blockquote name="0e79" id="0e79" class="graf graf--blockquote graf-after--blockquote">}</blockquote><blockquote name="3c61" id="3c61" class="graf graf--blockquote graf-after--blockquote">//metadata must be converted into an array</blockquote><blockquote name="1fca" id="1fca" class="graf graf--blockquote graf-after--blockquote">//uploading. Timers are for a TODO measuring upload &amp; parsing time</blockquote><blockquote name="13cc" id="13cc" class="graf graf--blockquote graf-after--blockquote">startUploadTimer = Date.now();</blockquote><blockquote name="5d29" id="5d29" class="graf graf--blockquote graf-after--blockquote">console.log(“start upload”, startUploadTimer);</blockquote><blockquote name="02e3" id="02e3" class="graf graf--blockquote graf-after--blockquote">let result = client.videos.upload(files.source.path, {title: fields.title, mp4Support: mp4Support});</blockquote><blockquote name="618e" id="618e" class="graf graf--blockquote graf-after--blockquote">});</blockquote><blockquote name="3de9" id="3de9" class="graf graf--blockquote graf-after--blockquote">});</blockquote><blockquote name="bb9c" id="bb9c" class="graf graf--blockquote graf-after--blockquote">}).catch(function(error) {</blockquote><blockquote name="915a" id="915a" class="graf graf--blockquote graf-after--blockquote">console.error(error);</blockquote><blockquote name="6a51" id="6a51" class="graf graf--blockquote graf-after--blockquote">});;</blockquote><blockquote name="58df" id="58df" class="graf graf--blockquote graf-after--blockquote">}</blockquote><p name="9a05" id="9a05" class="graf graf--p graf-after--blockquote">We are now building the POST response. Formidable saves the video in the directory specified in the .env variable videoDir (this doesn’t have to be private, but it is nice to save all configurable variables in one place). When the upload requests mp4 support, the variable must be a boolean, so we use the string from the response to create the corresponding boolean value. The email validator validates the email, and if the email is valid — we use production credentials at api.video (permanent video hosting). If there is no e-mail, or it is not valid, the video is instead processed in the Sandbox, meaning that it will be watermarked &amp; deleted after 72 hours. For your use — you probably just want to post to production, so you can simplfy this logic.</p><p name="6f79" id="6f79" class="graf graf--p graf-after--p">Finally, we begin the upload of the video to api.video (and capture the time of the upload start).</p><p name="3a5e" id="3a5e" class="graf graf--p graf-after--p">If you try to run this code now, it will hang — we are not yet listening for the response from api.video. However, adding:</p><blockquote name="d4b2" id="d4b2" class="graf graf--blockquote graf-after--p">console.log(result);</blockquote><p name="8a98" id="8a98" class="graf graf--p graf-after--blockquote">Will show the JSON response from api.video:</p><blockquote name="77ff" id="77ff" class="graf graf--blockquote graf-after--p">{</blockquote><blockquote name="4224" id="4224" class="graf graf--blockquote graf-after--blockquote">videoId: ‘vi4Injp5dMt6CNsMMjJ61k8Z’,</blockquote><blockquote name="5a5b" id="5a5b" class="graf graf--blockquote graf-after--blockquote">title: ‘video title’,</blockquote><blockquote name="00f1" id="00f1" class="graf graf--blockquote graf-after--blockquote">description: ‘video uploaded by:&lt;email address&gt;’,</blockquote><blockquote name="8593" id="8593" class="graf graf--blockquote graf-after--blockquote">public: true,</blockquote><blockquote name="e856" id="e856" class="graf graf--blockquote graf-after--blockquote">panoramic: false,</blockquote><blockquote name="a4b6" id="a4b6" class="graf graf--blockquote graf-after--blockquote">mp4Support: true,</blockquote><blockquote name="4bab" id="4bab" class="graf graf--blockquote graf-after--blockquote">tags: [],</blockquote><blockquote name="58c2" id="58c2" class="graf graf--blockquote graf-after--blockquote">metadata: [],</blockquote><blockquote name="e128" id="e128" class="graf graf--blockquote graf-after--blockquote">source: { type: ‘upload’, uri: ‘/videos/vi4Injp5dMt6CNsMMjJ61k8Z/source’ },</blockquote><blockquote name="1fb6" id="1fb6" class="graf graf--blockquote graf-after--blockquote">assets: {</blockquote><blockquote name="669b" id="669b" class="graf graf--blockquote graf-after--blockquote">iframe: ‘&lt;iframe src=”https://embed.api.video/vod/vi4Injp5dMt6CNsMMjJ61k8Z&quot; width=”100%” height=”100%” frameborder=”0&quot; scrolling=”no” allowfullscreen=””&gt;&lt;/iframe&gt;’,</blockquote><blockquote name="2304" id="2304" class="graf graf--blockquote graf-after--blockquote">player: ‘https://embed.api.video/vod/vi4Injp5dMt6CNsMMjJ61k8Z&#39;,</blockquote><blockquote name="3c13" id="3c13" class="graf graf--blockquote graf-after--blockquote">hls: ‘https://cdn.api.video/vod/vi4Injp5dMt6CNsMMjJ61k8Z/hls/manifest.m3u8&#39;,</blockquote><blockquote name="a02b" id="a02b" class="graf graf--blockquote graf-after--blockquote">thumbnail: ‘https://cdn.api.video/vod/vi4Injp5dMt6CNsMMjJ61k8Z/thumbnail.jpg&#39;</blockquote><blockquote name="13b4" id="13b4" class="graf graf--blockquote graf-after--blockquote">},</blockquote><blockquote name="14ab" id="14ab" class="graf graf--blockquote graf-after--blockquote">publishedAt: ‘2020–02–23T21:08:09+00:00’</blockquote><blockquote name="4b66" id="4b66" class="graf graf--blockquote graf-after--blockquote">}</blockquote><p name="e93e" id="e93e" class="graf graf--p graf-after--blockquote">The videoID is important to display and playback the video, as are the assets. We also can see useful metadata about the video — Mp4Support, Panoramic, public/private, etc. Note that there is no mp4 url — the video must be encoded to receive that url, so we’ll grab it later.</p><h3 name="78ac" id="78ac" class="graf graf--h3 graf-after--p">Video Upload Response</h3><p name="726b" id="726b" class="graf graf--p graf-after--h3">After the “let result = client.videos.upload(files.source.path, {title: fields.title, mp4Support: mp4Support});” paste in the lines below.</p><p name="dcc0" id="dcc0" class="graf graf--p graf-after--p">We listen for the result from the upload. This allows us to mark upload completed (to measure the elapsed upload time). If the video has successfully been uploaded to api.video, we now have 2 copies of the video: one on the node server, and the other at api.video. Fs.unlink deletes the file on the node server. The JSON response gives us the videoId at api.video, and links to the iframe and player video urls (which we assign to variables). The mp4 url is only presented in this response when encoding is finished.</p><p name="9987" id="9987" class="graf graf--p graf-after--p">Even though we have the urls to the videos, they have not been processed yet. To determine if the video is playable, we call the videoStatus function. This sends a request to api.video to obtain the video status. The response is a JSON with lots of details about upload status, file size, and metadata like the dimensions and bitrate (you can learn more about these parameters in the <a href="https://docs.api.video/5.1/videos/show-video-status" data-href="https://docs.api.video/5.1/videos/show-video-status" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">documentation</a>):</p><blockquote name="9ac1" id="9ac1" class="graf graf--blockquote graf-after--p">{</blockquote><blockquote name="abb2" id="abb2" class="graf graf--blockquote graf-after--blockquote">ingest: IngestStatus {</blockquote><blockquote name="7df7" id="7df7" class="graf graf--blockquote graf-after--blockquote">status: ‘uploaded’,</blockquote><blockquote name="88a8" id="88a8" class="graf graf--blockquote graf-after--blockquote">filesize: 13371095,</blockquote><blockquote name="091c" id="091c" class="graf graf--blockquote graf-after--blockquote">receivedBytes: []</blockquote><blockquote name="e4a4" id="e4a4" class="graf graf--blockquote graf-after--blockquote">},</blockquote><blockquote name="d087" id="d087" class="graf graf--blockquote graf-after--blockquote">encoding: EncodingStatus {</blockquote><blockquote name="76df" id="76df" class="graf graf--blockquote graf-after--blockquote">playable: true,</blockquote><blockquote name="df23" id="df23" class="graf graf--blockquote graf-after--blockquote">qualities: [ [Object], [Object], [Object], [Object], [Object], [Object] ],</blockquote><blockquote name="1945" id="1945" class="graf graf--blockquote graf-after--blockquote">metadata: {</blockquote><blockquote name="a9e9" id="a9e9" class="graf graf--blockquote graf-after--blockquote">width: 1920,</blockquote><blockquote name="836c" id="836c" class="graf graf--blockquote graf-after--blockquote">height: 1080,</blockquote><blockquote name="569e" id="569e" class="graf graf--blockquote graf-after--blockquote">bitrate: 4553.93,</blockquote><blockquote name="1044" id="1044" class="graf graf--blockquote graf-after--blockquote">duration: 23,</blockquote><blockquote name="1899" id="1899" class="graf graf--blockquote graf-after--blockquote">framerate: 30000,</blockquote><blockquote name="6b35" id="6b35" class="graf graf--blockquote graf-after--blockquote">samplerate: 0,</blockquote><blockquote name="3dcd" id="3dcd" class="graf graf--blockquote graf-after--blockquote">videoCodec: ‘h264’,</blockquote><blockquote name="fa1a" id="fa1a" class="graf graf--blockquote graf-after--blockquote">audioCodec: ‘’,</blockquote><blockquote name="eef6" id="eef6" class="graf graf--blockquote graf-after--blockquote">aspectRatio: null</blockquote><blockquote name="09a2" id="09a2" class="graf graf--blockquote graf-after--blockquote">}</blockquote><blockquote name="0eb3" id="0eb3" class="graf graf--blockquote graf-after--blockquote">}</blockquote><blockquote name="8119" id="8119" class="graf graf--blockquote graf-after--blockquote">}</blockquote><p name="6dae" id="6dae" class="graf graf--p graf-after--blockquote">Reading the videoStats.encoding.playable value tells us if it is ready to play or not. If it is not ready, we call videoStatus again recursively until we get the affirmative response. When we receive that ‘playable’ is true (as in the example above), the function can then query for the MP4 url, and return the view to the user: return res.render(‘video’, {iframe, player, uploadSeconds,processSeconds});</p><p name="5810" id="5810" class="graf graf--p graf-after--p">This means that video.pug will be displayed to the end user with some variables (the urls of the video, and timings on upload and processing). We’ll discuss that view in the next section.</p><blockquote name="a945" id="a945" class="graf graf--blockquote graf-after--p">//the result is the upload response</blockquote><blockquote name="09be" id="09be" class="graf graf--blockquote graf-after--blockquote">//see <a href="https://docs.api.video/5.1/videos/create-video" data-href="https://docs.api.video/5.1/videos/create-video" class="markup--anchor markup--blockquote-anchor" rel="noopener" target="_blank">https://docs.api.video/5.1/videos/create-video</a></blockquote><blockquote name="ed91" id="ed91" class="graf graf--blockquote graf-after--blockquote">//for JSON details</blockquote><blockquote name="6333" id="6333" class="graf graf--blockquote graf-after--blockquote">result.then(function(video) {</blockquote><blockquote name="531a" id="531a" class="graf graf--blockquote graf-after--blockquote">uploadCompleteTimer = Date.now();</blockquote><blockquote name="90f8" id="90f8" class="graf graf--blockquote graf-after--blockquote">console.log(“upload complete”, uploadCompleteTimer);</blockquote><blockquote name="aae2" id="aae2" class="graf graf--blockquote graf-after--blockquote">//delete file on node server</blockquote><blockquote name="e67f" id="e67f" class="graf graf--blockquote graf-after--blockquote">fs.unlink(files.source.path, function (err) {</blockquote><blockquote name="7ae2" id="7ae2" class="graf graf--blockquote graf-after--blockquote">if (err) throw err;</blockquote><blockquote name="6922" id="6922" class="graf graf--blockquote graf-after--blockquote">// if no error, file has been deleted successfully</blockquote><blockquote name="1a54" id="1a54" class="graf graf--blockquote graf-after--blockquote">console.log(‘File deleted!’);</blockquote><blockquote name="3984" id="3984" class="graf graf--blockquote graf-after--blockquote">});</blockquote><blockquote name="db5b" id="db5b" class="graf graf--blockquote graf-after--blockquote">//read information from API.video upload JSON response</blockquote><blockquote name="cf67" id="cf67" class="graf graf--blockquote graf-after--blockquote">console.log(‘video’, video);</blockquote><blockquote name="6dc7" id="6dc7" class="graf graf--blockquote graf-after--blockquote">let videoId = video.videoId;</blockquote><blockquote name="458d" id="458d" class="graf graf--blockquote graf-after--blockquote">console.log(‘videoId’, videoId);</blockquote><blockquote name="57f6" id="57f6" class="graf graf--blockquote graf-after--blockquote">console.log(‘player’, video.assets.player);</blockquote><blockquote name="ad51" id="ad51" class="graf graf--blockquote graf-after--blockquote">let iframe = video.assets.iframe;</blockquote><blockquote name="e8c5" id="e8c5" class="graf graf--blockquote graf-after--blockquote">let player = video.assets.player;</blockquote><blockquote name="76bf" id="76bf" class="graf graf--blockquote graf-after--blockquote">let mp4 = video.assets.mp4;</blockquote><blockquote name="aa5a" id="aa5a" class="graf graf--blockquote graf-after--blockquote">//check video status until it is published</blockquote><blockquote name="b5a6" id="b5a6" class="graf graf--blockquote graf-after--blockquote">//when video is playable resturn the video page</blockquote><blockquote name="d9b0" id="d9b0" class="graf graf--blockquote graf-after--blockquote">videoStatus(video);</blockquote><blockquote name="87c3" id="87c3" class="graf graf--blockquote graf-after--blockquote">//this means that the video is now playable</blockquote><blockquote name="6204" id="6204" class="graf graf--blockquote graf-after--blockquote">//so load video.pug, to display the video to the user.</blockquote><blockquote name="8cdb" id="8cdb" class="graf graf--blockquote graf-after--blockquote">function videoStatus(video) {</blockquote><blockquote name="e469" id="e469" class="graf graf--blockquote graf-after--blockquote">//console.log(video);</blockquote><blockquote name="648e" id="648e" class="graf graf--blockquote graf-after--blockquote">let videoId = video.videoId;</blockquote><blockquote name="014e" id="014e" class="graf graf--blockquote graf-after--blockquote">let iframe = video.assets.iframe;</blockquote><blockquote name="1db4" id="1db4" class="graf graf--blockquote graf-after--blockquote">let playable = false;</blockquote><blockquote name="99a8" id="99a8" class="graf graf--blockquote graf-after--blockquote">let status = client.videos.getStatus(videoId);</blockquote><blockquote name="0a80" id="0a80" class="graf graf--blockquote graf-after--blockquote">status.then(function(videoStats){</blockquote><blockquote name="0dae" id="0dae" class="graf graf--blockquote graf-after--blockquote">//console.log(‘status’, status);</blockquote><blockquote name="2f3b" id="2f3b" class="graf graf--blockquote graf-after--blockquote">//we have the video uploaded, now we need to wait for encoding to occur</blockquote><blockquote name="25ca" id="25ca" class="graf graf--blockquote graf-after--blockquote">playable = videoStats.encoding.playable;</blockquote><blockquote name="cbbb" id="cbbb" class="graf graf--blockquote graf-after--blockquote">console.log(‘video playable?’,videoStats.encoding.playable, playable);</blockquote><blockquote name="2911" id="2911" class="graf graf--blockquote graf-after--blockquote">if (playable){</blockquote><blockquote name="3fa4" id="3fa4" class="graf graf--blockquote graf-after--blockquote">//video is ready to be played</blockquote><blockquote name="f139" id="f139" class="graf graf--blockquote graf-after--blockquote">console.log(“ready to play the video”);</blockquote><blockquote name="305d" id="305d" class="graf graf--blockquote graf-after--blockquote">playReadyTimer = Date.now();</blockquote><blockquote name="b7d0" id="b7d0" class="graf graf--blockquote graf-after--blockquote">let uploadSeconds = (uploadCompleteTimer-startUploadTimer)/1000;</blockquote><blockquote name="ebb5" id="ebb5" class="graf graf--blockquote graf-after--blockquote">let processSeconds = (playReadyTimer — uploadCompleteTimer)/1000;</blockquote><blockquote name="a38e" id="a38e" class="graf graf--blockquote graf-after--blockquote">console.log(“video uploaded in: “, uploadSeconds);</blockquote><blockquote name="1966" id="1966" class="graf graf--blockquote graf-after--blockquote">console.log(“video processed in: “, processSeconds);</blockquote><blockquote name="6fa2" id="6fa2" class="graf graf--blockquote graf-after--blockquote">console.log(iframe);</blockquote><blockquote name="a289" id="a289" class="graf graf--blockquote graf-after--blockquote">if(useProduction){</blockquote><blockquote name="d703" id="d703" class="graf graf--blockquote graf-after--blockquote">//if user submitted an email — we are in prod — and can email the link to the videos.</blockquote><blockquote name="d07c" id="d07c" class="graf graf--blockquote graf-after--blockquote">intercomIntegration(fields.email,player, mp4,mp4Support,uploadSeconds,processSeconds);</blockquote><blockquote name="0fad" id="0fad" class="graf graf--blockquote graf-after--blockquote">}</blockquote><blockquote name="fd6b" id="fd6b" class="graf graf--blockquote graf-after--blockquote">return res.render(‘video’, {iframe, player, uploadSeconds,processSeconds});</blockquote><blockquote name="0083" id="0083" class="graf graf--blockquote graf-after--blockquote">}else{</blockquote><blockquote name="696c" id="696c" class="graf graf--blockquote graf-after--blockquote">//not ready so check again in 2 seconds.</blockquote><blockquote name="28d0" id="28d0" class="graf graf--blockquote graf-after--blockquote">console.log(“not ready yet” );</blockquote><blockquote name="bf23" id="bf23" class="graf graf--blockquote graf-after--blockquote">setTimeout(videoStatus(video),2000);</blockquote><blockquote name="dd56" id="dd56" class="graf graf--blockquote graf-after--blockquote">}</blockquote><blockquote name="1ab9" id="1ab9" class="graf graf--blockquote graf-after--blockquote">}).catch(function(error) {</blockquote><blockquote name="1c8e" id="1c8e" class="graf graf--blockquote graf-after--blockquote">console.error(error);</blockquote><blockquote name="a000" id="a000" class="graf graf--blockquote graf-after--blockquote">});;</blockquote><blockquote name="6146" id="6146" class="graf graf--blockquote graf-after--blockquote">}</blockquote><h3 name="9043" id="9043" class="graf graf--h3 graf-after--blockquote">Displaying the Video</h3><p name="a925" id="a925" class="graf graf--p graf-after--h3">The Video.pug file is a simple html file that simply adds an iframe for the video, and reports the elapsed times for upload and processing of the video. The variables are ensconced in #{} tags. One other interesting thing to note is adding #autoplay to the url tells the video player to autoplay the video (you can also add #loop to loop the video).</p><blockquote name="bbb9" id="bbb9" class="graf graf--blockquote graf-after--p">head</blockquote><blockquote name="fca8" id="fca8" class="graf graf--blockquote graf-after--blockquote">link(rel=’stylesheet’, href=’style.css’)</blockquote><blockquote name="5153" id="5153" class="graf graf--blockquote graf-after--blockquote">link(rel=’icon’, href=’icon.ico’, type=’image/x-icon’)</blockquote><blockquote name="53a5" id="53a5" class="graf graf--blockquote graf-after--blockquote">body</blockquote><blockquote name="3a3d" id="3a3d" class="graf graf--blockquote graf-after--blockquote">header.header</blockquote><blockquote name="168f" id="168f" class="graf graf--blockquote graf-after--blockquote">h1 Your Video is ready to play!</blockquote><blockquote name="e9f6" id="e9f6" class="graf graf--blockquote graf-after--blockquote">div.video</blockquote><blockquote name="212c" id="212c" class="graf graf--blockquote graf-after--blockquote">p &lt;iframe src=#{player}#autoplay width=”100%”” height=”100%” frameborder=”0&quot; scrolling=”no” allowfullscreen=””&gt;&lt;/iframe&gt;</blockquote><blockquote name="17c5" id="17c5" class="graf graf--blockquote graf-after--blockquote">p Check your e-mail for a link to the video.</blockquote><blockquote name="ea9f" id="ea9f" class="graf graf--blockquote graf-after--blockquote">p Video uploaded in #{uploadSeconds}s, and processed in #{processSeconds}s.</blockquote><blockquote name="8c12" id="8c12" class="graf graf--blockquote graf-after--blockquote">p &lt;a href=”/”&gt;Upload another video&lt;/a&gt;.</blockquote><p name="58f2" id="58f2" class="graf graf--p graf-after--blockquote">And there we have it, a working video upload tool, where the response page shows the encoded video, along with the time for upload and for processing! Pretty cool!</p><figure name="1c54" id="1c54" class="graf graf--figure graf-after--p"><div class="aspectRatioPlaceholder is-locked" style="max-width: 700px; max-height: 513px;"><div class="aspectRatioPlaceholder-fill" style="padding-bottom: 73.3%;"></div><img class="graf-image" data-image-id="1*Uie4dYQvwgEeYf_D3visAg.png" data-width="946" data-height="693" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*Uie4dYQvwgEeYf_D3visAg.png"></div></figure><h3 name="1389" id="1389" class="graf graf--h3 graf-after--figure">Optional Step: Email integration</h3><p name="0b00" id="0b00" class="graf graf--p graf-after--h3">In the video upload response section, there is a line of code that calls the intercom integration:</p><blockquote name="9500" id="9500" class="graf graf--blockquote graf-after--p">intercomIntegration(fields.email,player, mp4,mp4Support,uploadSeconds,processSeconds);</blockquote><blockquote name="8cf8" id="8cf8" class="graf graf--blockquote graf-after--blockquote">The function for the integration reads as:</blockquote><blockquote name="5d65" id="5d65" class="graf graf--blockquote graf-after--blockquote">function intercomIntegration(email,player, mp4,mp4Support,upload,process){</blockquote><blockquote name="c987" id="c987" class="graf graf--blockquote graf-after--blockquote">//while the video is processing, upload the email to intercom</blockquote><blockquote name="b677" id="b677" class="graf graf--blockquote graf-after--blockquote">//there is a valid email address, let’s write it to Indercom</blockquote><blockquote name="e783" id="e783" class="graf graf--blockquote graf-after--blockquote">// Create a contact with attributes</blockquote><blockquote name="c2bf" id="c2bf" class="graf graf--blockquote graf-after--blockquote">intercomClient.leads.create({ email: email, tags: “upload demo”}, function (r) {</blockquote><blockquote name="776c" id="776c" class="graf graf--blockquote graf-after--blockquote">var intercomId=””;</blockquote><blockquote name="f8ef" id="f8ef" class="graf graf--blockquote graf-after--blockquote">console.log(“user creation:”, r.body);</blockquote><blockquote name="42f4" id="42f4" class="graf graf--blockquote graf-after--blockquote">if(r.body.errors){</blockquote><blockquote name="ae70" id="ae70" class="graf graf--blockquote graf-after--blockquote">//user already exists</blockquote><blockquote name="2966" id="2966" class="graf graf--blockquote graf-after--blockquote">//get the ID</blockquote><blockquote name="d950" id="d950" class="graf graf--blockquote graf-after--blockquote">var errorString = r.body.errors[0].message;</blockquote><blockquote name="1bad" id="1bad" class="graf graf--blockquote graf-after--blockquote">console.log(“errorstring”,errorString);</blockquote><blockquote name="e725" id="e725" class="graf graf--blockquote graf-after--blockquote">var idStart = errorString.lastIndexOf(“=”) +1;</blockquote><blockquote name="4e70" id="4e70" class="graf graf--blockquote graf-after--blockquote">intercomId =errorString.substring(idStart);</blockquote><blockquote name="d643" id="d643" class="graf graf--blockquote graf-after--blockquote">console.log(“retrived id”,intercomId);</blockquote><blockquote name="8a27" id="8a27" class="graf graf--blockquote graf-after--blockquote">}else {</blockquote><blockquote name="3292" id="3292" class="graf graf--blockquote graf-after--blockquote">//user created</blockquote><blockquote name="17f5" id="17f5" class="graf graf--blockquote graf-after--blockquote">intercomId = r.body.id;</blockquote><blockquote name="7538" id="7538" class="graf graf--blockquote graf-after--blockquote">console.log(“user creation:”, r.body);</blockquote><blockquote name="32c3" id="32c3" class="graf graf--blockquote graf-after--blockquote">}</blockquote><blockquote name="074e" id="074e" class="graf graf--blockquote graf-after--blockquote">//add upload demo tag</blockquote><blockquote name="714d" id="714d" class="graf graf--blockquote graf-after--blockquote">intercomClient.tags.tag({ name: ‘upload demo’, users: [{ id: intercomId }] }, function (tag){</blockquote><blockquote name="de08" id="de08" class="graf graf--blockquote graf-after--blockquote">console.log(“tag addition”, tag.body);</blockquote><blockquote name="156f" id="156f" class="graf graf--blockquote graf-after--blockquote">});</blockquote><blockquote name="e94a" id="e94a" class="graf graf--blockquote graf-after--blockquote">//send an email with the video links</blockquote><blockquote name="4cef" id="4cef" class="graf graf--blockquote graf-after--blockquote">var emailbody = “”;</blockquote><blockquote name="9ca4" id="9ca4" class="graf graf--blockquote graf-after--blockquote">if (mp4Support) {</blockquote><blockquote name="1920" id="1920" class="graf graf--blockquote graf-after--blockquote">emailbody = “Hi “ +email+”,\n Thank you for using our upload demo. Your video was uploaded in “+upload+” seconds, and processed in “+process+” seconds. You can see your video here: “</blockquote><blockquote name="3235" id="3235" class="graf graf--blockquote graf-after--blockquote">+player+”. You can view the mp4 at “ + mp4 +”. Come learn more at &lt;a href\”https://api.video\&quot;&gt; api.video&lt;/a&gt;”</blockquote><blockquote name="e50c" id="e50c" class="graf graf--blockquote graf-after--blockquote">+”\n Thanks, \n the api.video team”;</blockquote><blockquote name="54e6" id="54e6" class="graf graf--blockquote graf-after--blockquote">}else{</blockquote><blockquote name="26e0" id="26e0" class="graf graf--blockquote graf-after--blockquote">emailbody = “Hi “ +email+”,\n Thank you for using our upload demo. Your video was uploaded in “+upload+” seconds, and processed in “+process+” seconds. You can see your video here: “</blockquote><blockquote name="1341" id="1341" class="graf graf--blockquote graf-after--blockquote">+player+”. Come learn more at &lt;a href\”https://api.video\&quot;&gt; api.video&lt;/a&gt;”</blockquote><blockquote name="bc5e" id="bc5e" class="graf graf--blockquote graf-after--blockquote">+”\n Thanks, \n the api.video team”;</blockquote><blockquote name="bb03" id="bb03" class="graf graf--blockquote graf-after--blockquote">}</blockquote><blockquote name="118b" id="118b" class="graf graf--blockquote graf-after--blockquote">console.log(“emailbody”, emailbody);</blockquote><blockquote name="4095" id="4095" class="graf graf--blockquote graf-after--blockquote">console.log(“intercom admin:”, intercomAdmin);</blockquote><blockquote name="42a4" id="42a4" class="graf graf--blockquote graf-after--blockquote">var message = {</blockquote><blockquote name="4ed4" id="4ed4" class="graf graf--blockquote graf-after--blockquote">message_type: “email”,</blockquote><blockquote name="2667" id="2667" class="graf graf--blockquote graf-after--blockquote">subject: “Thank you for using the api.video upload demo”,</blockquote><blockquote name="77cd" id="77cd" class="graf graf--blockquote graf-after--blockquote">body: emailbody,</blockquote><blockquote name="bdb9" id="bdb9" class="graf graf--blockquote graf-after--blockquote">template: “plain”,</blockquote><blockquote name="aed9" id="aed9" class="graf graf--blockquote graf-after--blockquote">from: {</blockquote><blockquote name="8c6d" id="8c6d" class="graf graf--blockquote graf-after--blockquote">type: “admin”,</blockquote><blockquote name="193e" id="193e" class="graf graf--blockquote graf-after--blockquote">id: intercomAdmin</blockquote><blockquote name="c30c" id="c30c" class="graf graf--blockquote graf-after--blockquote">},</blockquote><blockquote name="f648" id="f648" class="graf graf--blockquote graf-after--blockquote">to: {</blockquote><blockquote name="b0f8" id="b0f8" class="graf graf--blockquote graf-after--blockquote">type: “user”,</blockquote><blockquote name="9242" id="9242" class="graf graf--blockquote graf-after--blockquote">id: intercomId</blockquote><blockquote name="28d9" id="28d9" class="graf graf--blockquote graf-after--blockquote">}</blockquote><blockquote name="3bcb" id="3bcb" class="graf graf--blockquote graf-after--blockquote">}</blockquote><blockquote name="2ab2" id="2ab2" class="graf graf--blockquote graf-after--blockquote">intercomClient.messages.create(message, function(email){</blockquote><blockquote name="221d" id="221d" class="graf graf--blockquote graf-after--blockquote">console.log(“email: “, email.body);</blockquote><blockquote name="0689" id="0689" class="graf graf--blockquote graf-after--blockquote">});</blockquote><blockquote name="6d7f" id="6d7f" class="graf graf--blockquote graf-after--blockquote">});</blockquote><blockquote name="8f4e" id="8f4e" class="graf graf--blockquote graf-after--blockquote">}</blockquote><p name="162e" id="162e" class="graf graf--p graf-after--blockquote">We first create a lead (or a contact) inside Intercom. This will come back with an id that uniquely IDs the user. If the email address already exists, Intercom returns an error message that says “There is already a user with the id=&lt;idnumber&gt;.” So, if the user already exists, we can parse the error message to grab the user id.</p><p name="e6d8" id="e6d8" class="graf graf--p graf-after--p">Then we can add a tag to Intercom to show that the user has used the video upload tool, and we send an email to the user’s email address with links to the videos, and the time it took to upload and process the videos. The text of the email is right in the code, so easy to modify.</p><h3 name="5dcb" id="5dcb" class="graf graf--h3 graf-after--p">Putting it All Together</h3><p name="90ff" id="90ff" class="graf graf--p graf-after--h3">Here’s a video of the end user experience</p><div name="9342" id="9342" class="graf graf--mixtapeEmbed graf-after--p"><a href="https://embed.api.video/vod/vimBdA57SK8tnph6vA7N093" data-href="https://embed.api.video/vod/vimBdA57SK8tnph6vA7N093" class="markup--anchor markup--mixtapeEmbed-anchor" title="https://embed.api.video/vod/vimBdA57SK8tnph6vA7N093"><strong class="markup--strong markup--mixtapeEmbed-strong">api.video</strong><br><em class="markup--em markup--mixtapeEmbed-em">Video Player by api.video</em>embed.api.video</a><a href="https://embed.api.video/vod/vimBdA57SK8tnph6vA7N093" class="js-mixtapeImage mixtapeImage mixtapeImage--empty u-ignoreBlock" data-media-id="5cbd95a48cdaff66b0500b5e676b9c03"></a></div><h3 name="6cd7" id="6cd7" class="graf graf--h3 graf-after--mixtapeEmbed">Conclusion</h3><p name="d891" id="d891" class="graf graf--p graf-after--h3 graf--trailing">We’ve built a video uploader using Node,js and api.video. The easy to build tool now gives us the ability to easily share our videos across our internet properties. Using Node and api.video, the entire process creates a simple easy to use interface to take regular videos, and convert them into video streams. If this demo has inspired you (or if you have any questions), let us know by posting in our <a href="https://community.api.video/" data-href="https://community.api.video/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">community</a> forums.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@api.video" class="p-author h-card">api.video</a> on <a href="https://medium.com/p/3d3519d03e8f"><time class="dt-published" datetime="2020-02-26T00:09:36.071Z">February 26, 2020</time></a>.</p><p><a href="https://medium.com/@api.video/building-a-video-upload-demo-with-node-js-and-api-video-3d3519d03e8f" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on March 19, 2020.</p></footer></article></body></html>